# ๐ค Step 2: AI-Powered Intelligent Chunking

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ุชูุณูู ุฐูู ุจุงุณุชุฎุฏุงู Claude API ูุญุงูุธ ุนูู 100% ูู ุงููุตุงุฏุฑ ูุงููุฑุงุฌุน.

**ุงูููุฒุงุช ุงูุฃุณุงุณูุฉ:**
- โ ุงุณุชุฎุฑุงุฌ ุชููุงุฆู ูููุตุงุฏุฑ ูู ุงููุตูุต
- โ ุชูุณูู ุฐูู ุฅูู ุฃูุณุงู ูููุฑุงุช
- โ ุงูุญูุงุธ ุงููุงูู ุนูู ุฌููุน ุงููุตุงุฏุฑ (0% ููุฏุงู)
- โ Validation ุดุงูู ูู ูู ูุฑุญูุฉ
- โ ุชุชุจุน ุงูุชูููุฉ ูุงูุฅุญุตุงุฆูุงุช

---

## ๐ ุงูุจุฏุก ุงูุณุฑูุน

### 1. ุงูุชุซุจูุช

```bash
# ุชุซุจูุช ุงูููุชุจุงุช
pip install anthropic python-dotenv pyyaml tqdm

# ุฃู
pip install -r requirements.txt
```

### 2. ุงูุฅุนุฏุงุฏ

```bash
# ุฅูุดุงุก ููู .env
cp .env.example .env

# ุชุญุฑูุฑ .env ูุฅุถุงูุฉ API key
nano .env
```

**ูู ููู `.env`:**
```bash
ANTHROPIC_API_KEY=sk-ant-your-key-here
```

**ุงูุญุตูู ุนูู API Key:**
1. ุงุฐูุจ ุฅูู https://console.anthropic.com/
2. ุณุฌู ุฏุฎูู ุฃู ุฃูุดุฆ ุญุณุงุจ
3. ุงูุณุฎ API Key

### 3. ุฅุถุงูุฉ ูููุงุช ุงููุตูุต

ุถุน ูููุงุช ุงููุตูุต ูู `data/raw/`:

```
data/raw/
โโโ ุงูุดุงูู_ูู_ุงูุฅูุงูุฉ_ุฌ1.txt
โโโ ุงูุดุงูู_ูู_ุงูุฅูุงูุฉ_ุฌ2.txt
โโโ ...
```

### 4. ุชุญุฏูุซ ุงูููุฏ

ุงูุชุญ `build/step2_ai_chunking.py` ูุญุฏุซ ุงููุชุบูุฑ `volumes`:

```python
volumes = {
    1: 'data/raw/ุงูุดุงูู_ูู_ุงูุฅูุงูุฉ_ุฌ1.txt',
    2: 'data/raw/ุงูุดุงูู_ูู_ุงูุฅูุงูุฉ_ุฌ2.txt',
    # ุฃุถู ุงููุฒูุฏ ุญุณุจ ุงูุญุงุฌุฉ
}
```

### 5. ุงูุชุดุบูู

```bash
python build/step2_ai_chunking.py
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
๐ฏ AI-Powered Intelligent Chunking
============================================================
๐ Processing Volume 1
============================================================
๐ Phase 1: Extracting citations from volume 1...
   ๐ค Calling Claude API: Extract citations v1...
      Tokens: 45231 in, 3421 out
      Cost: $0.1876
โ Extracted 1117 citations
   Saved to: data/processed/citations_extracted/citations_ุฌ1.json

๐ Phase 2: Creating sections for volume 1...
   ๐ค Calling Claude API: Create sections v1...
      Tokens: 48123 in, 5231 out
      Cost: $0.2234
โ Created 80 sections

๐ Phase 3: Creating paragraphs
Processing sections: 100%|โโโโโโโโโโโโ| 80/80
โ Created 700 total paragraphs

... (ุงููุฒูุฏ ูู ุงูุฃุฌุฒุงุก)

๐ Final Statistics
============================================================
๐ค API Usage:
   Total API calls:   245
   Input tokens:      523,421
   Output tokens:     87,234
   Total tokens:      610,655

๐ฐ Cost:
   Total cost:        $2.47
   Avg cost/volume:   $0.62

๐ Processing:
   Volumes processed: 4

๐ Chunking Complete!
============================================================
๐ Output files:
   data/processed/documents.json
   data/processed/sections.json
   data/processed/paragraphs.json
   data/processed/chunking_stats.json
```

---

## ๐ ุงููุฑุงุญู ุงูุซูุงุซ

### ุงููุฑุญูุฉ 1: ุงุณุชุฎุฑุงุฌ ุงููุตุงุฏุฑ

**ุงููููุฉ:**
- ูุฑุงุกุฉ ุงููุต ูุงููุงู
- ุงุณุชุฎุฑุงุฌ ูู ุงููุตุงุฏุฑ (ุฑูููุฉ ููุตูุฉ)
- ุชุตููููุง ูุญูุธ ุงูุณูุงู

**ุงููุฎุฑุฌุงุช:**
```json
{
  "volume_number": 1,
  "total_citations": 1117,
  "citations": [
    {
      "citation_id": "cite_v1_001",
      "appearance_in_text": "(1)",
      "source": {
        "book_name": "ุชุงุฑูุฎ ุงูุทุจุฑู",
        "full_reference": "ุชุงุฑูุฎ ุงูุทุจุฑูุ ุฌ3ุ ุต45"
      },
      "context": "ููุง ุฐูุฑ ูู ุงููุตุฏุฑ (1) ุฃู..."
    }
  ]
}
```

### ุงููุฑุญูุฉ 2: ุชูุณูู ุงูุฃูุณุงู (Sections)

**ุงููููุฉ:**
- ุชูุณูู ุงููุต ุฅูู ุฃูุณุงู ููุถูุนูุฉ
- ุฑุจุท ูู ูุณู ุจูุตุงุฏุฑู
- ุงูุญูุงุธ ุนูู 100% ูู ุงููุตุงุฏุฑ

**ุงููุฎุฑุฌุงุช:**
```json
{
  "sections": [
    {
      "section_id": "shafi_v1_s001",
      "title": "ูู ุฅุซุจุงุช ุงูุฅูุงูุฉ",
      "text": "ุงููุต ุงููุงูู...",
      "citations": [...],
      "parent_doc": "shafi_v1"
    }
  ]
}
```

### ุงููุฑุญูุฉ 3: ุชูุณูู ุงูููุฑุงุช (Paragraphs)

**ุงููููุฉ:**
- ุชูุณูู ูู ูุณู ุฅูู ููุฑุงุช ุตุบูุฑุฉ
- ุฑุจุท ูู ููุฑุฉ ุจูุตุงุฏุฑูุง
- ุงูุญูุงุธ ุนูู ุงูุงุณุชููุงููุฉ

**ุงููุฎุฑุฌุงุช:**
```json
{
  "paragraphs": [
    {
      "para_id": "shafi_v1_s001_p001",
      "text": "ูุต ุงูููุฑุฉ...",
      "citations": [...],
      "parent_section": "shafi_v1_s001"
    }
  ]
}
```

---

## โ Validation Framework

ุงููุธุงู ูุชุญูู ุชููุงุฆูุงู ูู:

### 1. ุนุฏู ููุฏุงู ุงููุตุงุฏุฑ
```python
# ุงูุชุญูู ุจุนุฏ ูู ูุฑุญูุฉ
original_citations = 1117
sections_citations = 1117  โ
paragraphs_citations = 1117  โ
```

### 2. ุตุญุฉ ุงูุจููุฉ
```python
# ูู citation ูู:
- citation_id โ
- source {book_name, full_reference} โ
- context โ
```

### 3. ุงูุชุณูุณู ุงููุฑูู
```python
# ูู paragraph ูู parent_section โ
# ูู section ูู parent_doc โ
```

---

## ๐งช ุงูุงุฎุชุจุงุฑุงุช

```bash
# ุชุดุบูู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช
python tests/test_chunking.py
```

**ุงูุงุฎุชุจุงุฑุงุช ุงููุชููุฑุฉ:**
1. โ All Citations Preserved - ูุง ููุฏุงู ูู ุงููุตุงุฏุฑ
2. โ Chunks Have Sources - ูู chunk ูู ูุตุงุฏุฑู
3. โ No Broken Citations - ูุง ูุตุงุฏุฑ ููุณูุฑุฉ
4. โ Hierarchy Integrity - ุงูุชุณูุณู ุงููุฑูู ุณููู
5. โ JSON Structure - ุงูุจููุฉ ุตุญูุญุฉ

---

## ๐ฐ ุงูุชูููุฉ ุงููุชููุนุฉ

**ููุชุงุจ ูู 4 ุฃุฌุฒุงุก (ูุซู ุงูุดุงูู):**
- ุงููุฑุญูุฉ 1 (ุงุณุชุฎุฑุงุฌ ุงููุตุงุฏุฑ): ~$0.80
- ุงููุฑุญูุฉ 2 (ุงูุฃูุณุงู): ~$0.90
- ุงููุฑุญูุฉ 3 (ุงูููุฑุงุช): ~$0.80
- **ุงูุฅุฌูุงูู: ~$2.50**

**ุนูุงูู ูุคุซุฑุฉ:**
- ุทูู ุงููุต
- ุนุฏุฏ ุงููุตุงุฏุฑ
- ุชุนููุฏ ุงูุจููุฉ

**ุชูููุฑ ุงูุชูููุฉ:**
- ุงููุธุงู ูุญูุธ ุงููุชุงุฆุฌ ุงููุคูุชุฉ
- ูููู ุฅุนุงุฏุฉ ุงูุชุดุบูู ูู ุขุฎุฑ ููุทุฉ
- ูุง ุญุงุฌุฉ ูุฅุนุงุฏุฉ ุงููุนุงูุฌุฉ

---

## ๐ ุจููุฉ ุงููุฎุฑุฌุงุช

```
data/processed/
โโโ citations_extracted/
โ   โโโ citations_ุฌ1.json
โ   โโโ citations_ุฌ2.json
โ   โโโ ...
โโโ documents.json          # ูุณุชูู ุงููุซุงุฆู
โโโ sections.json           # ูุณุชูู ุงูุฃูุณุงู
โโโ paragraphs.json         # ูุณุชูู ุงูููุฑุงุช
โโโ chunking_stats.json     # ุงูุฅุญุตุงุฆูุงุช
```

---

## โ๏ธ ุงูุฅุนุฏุงุฏุงุช (config.yaml)

```yaml
chunking:
  # ุงููููุฐุฌ
  model: "claude-sonnet-4-20250514"
  max_tokens: 16000
  temperature: 0

  # API
  api_key_env: "ANTHROPIC_API_KEY"

  # ุงูุฅุฎุฑุงุฌ
  save_intermediate: true
  validate_output: true
```

---

## ๐ง ุญู ุงููุดุงูู

### ุฎุทุฃ: Missing API key

**ุงูุญู:**
```bash
# ุชุฃูุฏ ูู ูุฌูุฏ .env
ls -la .env

# ุชุฃูุฏ ูู ุงููุญุชูู
cat .env

# ูุฌุจ ุฃู ูุญุชูู:
ANTHROPIC_API_KEY=sk-ant-...
```

### ุฎุทุฃ: No module named 'anthropic'

**ุงูุญู:**
```bash
pip install anthropic
```

### ุชุญุฐูุฑ: Citations mismatch

**ุงูุณุจุจ:** Claude ูู ูุฑุจุท ูู ุงููุตุงุฏุฑ

**ุงูุญู:**
1. ุฑุงุฌุน ุงูู prompts
2. ุชุฃูุฏ ูู ูุถูุญ ุงูุชุนูููุงุช
3. ุฃุนุฏ ุชุดุบูู ุงููุฑุญูุฉ ุงููุนููุฉ

### ุจุทุก ุดุฏูุฏ

**ุงูุญู:**
```python
# ููู max_tokens ูู config.yaml
max_tokens: 8000  # ุจุฏูุงู ูู 16000
```

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ:**
   - ุงุญูุธ ูุณุฎุฉ ูู ุงููุชุงุฆุฌ ุจุงูุชุธุงู
   - ุงููุธุงู ูุญูุธ ุชููุงุฆูุงู ููู ุงุญุชูุงุทู ูุฏูู ุฃูุถู

2. **ุงููุตุงุฏุฑ ุงููุจูุฑุฉ:**
   - ุฅุฐุง ูุงู ุงููุชุงุจ ูุญุชูู >2000 ูุตุฏุฑ
   - ูุฏ ุชุญุชุงุฌ ูุชูุณููู ูุฏููุงู

3. **ุงูุชุฎุตูุต:**
   - ููููู ุชุนุฏูู ุงูู prompts ูู `build/prompts/`
   - ูุชุญุณูู ุงููุชุงุฆุฌ ุญุณุจ ููุน ุงููุต

---

## ๐ฏ ุงูุฎุทูุฉ ุงูุชุงููุฉ

ุจุนุฏ ุฅุชูุงู ูุฐู ุงููุฑุญูุฉ:

โ **ูุฏูู:**
- ุจูุงูุงุช ููุธูุฉ ูุฑููุงู
- ูุตุงุฏุฑ ูุฑุจูุทุฉ 100%
- ุฌุงูุฒุฉ ููู embeddings

โญ๏ธ **ุงูุฎุทูุฉ ุงูุชุงููุฉ:**
- **Step 3:** Embeddings & ChromaDB
- ุชุดุบูู: `python build/step3_embeddings_E5.py`

---

## ๐ ุงูุฏุนู

**ุฃุณุฆูุฉุ ูุดุงููุ**
- ุฑุงุฌุน ุงูุฃูุซูุฉ ูู `tests/test_chunking.py`
- ุงูุญุต ุงูุฅุญุตุงุฆูุงุช ูู `chunking_stats.json`
- ุชุญูู ูู ุงูุณุฌูุงุช

---

**ุขุฎุฑ ุชุญุฏูุซ:** ููููุจุฑ 2025
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุฅูุชุงุฌ
