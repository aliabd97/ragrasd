# ๐ฏ Step 3: Embeddings & Vector Database

## ๐ ุงูููุฎุต

ุชุญููู **753 ุนูุตุฑ** ูู ุงูุจูุงูุงุช ุงููุฑููุฉ ุฅูู **embeddings vectors** ูุจูุงุก **ChromaDB** ููุจุญุซ ุงูุณุฑูุน ูุงูุฏููู.

---

## ๐ฆ ุงููููุงุช

| ุงูููู | ุงููุตู | ุงูุญุฌู |
|------|-------|-------|
| **step3_embeddings.py** | ุงูุณูุฑูุจุช ุงูุฑุฆูุณู | ~500 ุณุทุฑ |
| **test_embeddings.py** | ุงูุงุฎุชุจุงุฑุงุช ุงูุดุงููุฉ | ~300 ุณุทุฑ |
| **STEP3_GUIDE.md** | ุฏููู ุงูุงุณุชุฎุฏุงู | - |
| **STEP3_RESULTS.md** | ุงููุชุงุฆุฌ (ุจุนุฏ ุงูุชุดุบูู) | - |
| **README_STEP3.md** | ูุฐุง ุงูููู | - |

---

## ๐ฏ ุงูุฃูุฏุงู

### ุงููุฏู ุงูุฑุฆูุณู:
โ ุจูุงุก vector database ูุงููุฉ ููุจุญุซ ุงูุฐูู

### ุงูุฃูุฏุงู ุงููุฑุนูุฉ:
1. โ ุชุญููู paraphrase-multilingual-mpnet-base-v2
2. โ ุชูููุฏ 753 embeddings (768 ุฃุจุนุงุฏ ููู ูุงุญุฏ)
3. โ ุจูุงุก ChromaDB ูุน 3 ุฃููุงุน (document, section, paragraph)
4. โ ุงุฎุชุจุงุฑ ุงูุจุญุซ ุงูุฃุณุงุณู
5. โ ุงุฎุชุจุงุฑ ุงูุจุญุซ ูุชุนุฏุฏ ุงููุณุชููุงุช

---

## ๐๏ธ ุงูุจููุฉ ุงูุชูููุฉ

### ุงููููุฐุฌ:
```
paraphrase-multilingual-mpnet-base-v2
โโโ ุงูุญุฌู: 420 MB
โโโ ุงูุฃุจุนุงุฏ: 768
โโโ ุงููุบุงุช: 50+ (ุจูุง ูููุง ุงูุนุฑุจูุฉ)
โโโ ุงูุณุฑุนุฉ: ~1 ุนูุตุฑ/ุซุงููุฉ (CPU)
```

### ูุงุนุฏุฉ ุงูุจูุงูุงุช:
```
ChromaDB
โโโ ุงูููุน: Vector Database
โโโ ุงููููุงุณ: Cosine Similarity
โโโ ุงูุนูุงุตุฑ: 753
โ   โโโ Documents: 4
โ   โโโ Sections: 315
โ   โโโ Paragraphs: 434
โโโ ุงูุญุฌู: ~100-200 MB
```

---

## ๐ ุณูุฑ ุงูุนูู

```
1. ุชุญููู ุงูุจูุงูุงุช
   โ
2. ุชุญููู ุงููููุฐุฌ (paraphrase-multilingual-mpnet-base-v2)
   โ
3. ุฅูุดุงุก ChromaDB
   โ
4. ูุนุงูุฌุฉ Documents (4)
   โ
5. ูุนุงูุฌุฉ Sections (315)
   โ
6. ูุนุงูุฌุฉ Paragraphs (434)
   โ
7. ุญูุธ ุงูุฅุญุตุงุฆูุงุช
   โ
8. ุงุฎุชุจุงุฑ ุงูุจุญุซ
   โ
9. โ ูุงุนุฏุฉ ุจูุงูุงุช ุฌุงูุฒุฉ!
```

---

## ๐ป ุงูุงุณุชุฎุฏุงู

### ุชุดุบูู ุจุณูุท:

```bash
python build/step3_embeddings.py
```

### ุชุดุบูู ูุน ุงุฎุชุจุงุฑ:

```bash
python build/step3_embeddings.py && python build/test_embeddings.py
```

---

## ๐ ุงููุฎุฑุฌุงุช ุงููุชููุนุฉ

### Terminal Output:

```
======================================================================
๐ Step 3: Generate Embeddings and Build Vector Database
======================================================================

๐ ุงููุฑุญูุฉ 1: ุชุญููู ุงูุจูุงูุงุช
----------------------------------------------------------------------
๐ ุชุญููู: documents.json
โ ุชู ุชุญููู 4 ุนูุตุฑ
๐ ุชุญููู: sections.json
โ ุชู ุชุญููู 315 ุนูุตุฑ
๐ ุชุญููู: paragraphs.json
โ ุชู ุชุญููู 434 ุนูุตุฑ

๐ ุงูุฅุฌูุงูู: 753 ุนูุตุฑ

๐ ุงููุฑุญูุฉ 2: ุชููุฆุฉ Embeddings Generator
----------------------------------------------------------------------
๐ฅ ุชุญููู ูููุฐุฌ Embeddings: paraphrase-multilingual-mpnet-base-v2
โ๏ธ ุงูุฌูุงุฒ: cpu
โ ุชู ุงูุชุญููู ูู 15.23 ุซุงููุฉ
๐ ุงูุฃุจุนุงุฏ: 768

๐ ุงููุฑุญูุฉ 3: ุชููุฆุฉ ChromaDB
----------------------------------------------------------------------
๐ ูุชุญ ChromaDB: data/database/chroma_db
๐๏ธ ุชู ุญุฐู collection ุงููุฏูู
โ ุชู ุฅูุดุงุก collection: islamic_books

๐ ุงููุฑุญูุฉ 4: ูุนุงูุฌุฉ Documents
----------------------------------------------------------------------
๐ข ุชูููุฏ embeddings ูู 4 document...
100%|โโโโโโโโโโโโโโโโ| 4/4 [00:05<00:00,  1.25s/it]
๐พ ุฅุถุงูุฉ Documents ุฅูู ChromaDB...
โ ุชู

๐ ุงููุฑุญูุฉ 5: ูุนุงูุฌุฉ Sections
----------------------------------------------------------------------
๐ข ุชูููุฏ embeddings ูู 315 section...
100%|โโโโโโโโโโโโโโ| 315/315 [05:15<00:00,  1.00it/s]
๐พ ุฅุถุงูุฉ Sections ุฅูู ChromaDB...
โ ุชู

๐ ุงููุฑุญูุฉ 6: ูุนุงูุฌุฉ Paragraphs
----------------------------------------------------------------------
๐ข ุชูููุฏ embeddings ูู 434 paragraph...
100%|โโโโโโโโโโโโโโ| 434/434 [07:10<00:00,  1.01it/s]
๐พ ุฅุถุงูุฉ Paragraphs ุฅูู ChromaDB...
โ ุชู

๐ ุงููุฑุญูุฉ 7: ุงูุฅุญุตุงุฆูุงุช ุงูููุงุฆูุฉ
----------------------------------------------------------------------
๐ ุงูุนูุงุตุฑ ุงููุนุงูุฌุฉ:
   - Documents: 4
   - Sections: 315
   - Paragraphs: 434
   - ุงูุฅุฌูุงูู: 753

๐พ ูุงุนุฏุฉ ุงูุจูุงูุงุช:
   - ุงูุนูุงุตุฑ ูู ChromaDB: 753
   - ุงููุณุงุฑ: data/database/chroma_db

โฑ๏ธ ุงูุฃุฏุงุก:
   - ุงูููุช ุงูุฅุฌูุงูู: 12.50 ุฏูููุฉ
   - ุงูุณุฑุนุฉ: 1.00 ุนูุตุฑ/ุซุงููุฉ

๐พ ุงูุฅุญุตุงุฆูุงุช ูุญููุธุฉ ูู: data/database/embeddings_stats.json

๐ ุงููุฑุญูุฉ 8: ุงุฎุชุจุงุฑ ุงูุจุญุซ
----------------------------------------------------------------------
๐ ุงุฎุชุจุงุฑ ุงูุจุญุซ ุนู: 'ุงูุฅูุงูุฉ'

๐ ุงููุชุงุฆุฌ (ุฃูู 3):

1. ID: shafi_v1_sec_015
   ุงูููุน: section
   ุงูุนููุงู: ุงููุงุฆููู ุจุงูุงุฎุชูุงุฑ - ุงููุฑูู ุงูุฃูู
   ุนุฏุฏ ุงููููุงุช: 2567

2. ID: shafi_v2_sec_025
   ุงูููุน: section
   ุงูุนููุงู: ุฃุฏูุฉ ุงูุฅูุงููุฉ ุนูู ุงููุต
   ุนุฏุฏ ุงููููุงุช: 2891

3. ID: shafi_v1_sec_015_para_003
   ุงูููุน: paragraph
   ุนุฏุฏ ุงููููุงุช: 987

======================================================================
โ ุชู ุฅููุงู Step 3 ุจูุฌุงุญ!
======================================================================

๐ฆ ุงููููุงุช ุงููุงุชุฌุฉ:
   - data/database/chroma_db
   - data/database/embeddings_stats.json

๐ฏ ุงูุฎุทูุฉ ุงูุชุงููุฉ: Step 4 - Query Analyzer
```

---

## โ ุงูุงุฎุชุจุงุฑุงุช

### ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช:

```bash
python build/test_embeddings.py
```

### ุงููุชูุฌุฉ ุงููุชููุนุฉ:

```
======================================================================
๐งช ุงุฎุชุจุงุฑุงุช Embeddings ู ChromaDB
======================================================================

๐งช ุงุฎุชุจุงุฑ 1: ูุฌูุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช
โ ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุฌูุฏุฉ

๐งช ุงุฎุชุจุงุฑ 2: ูุฌูุฏ collection
โ Collection ููุฌูุฏ

๐งช ุงุฎุชุจุงุฑ 3: ุนุฏุฏ ุงูุนูุงุตุฑ
๐ ุฅุฌูุงูู ุงูุนูุงุตุฑ: 753
โ ุนุฏุฏ ุงูุนูุงุตุฑ ุตุญูุญ

๐งช ุงุฎุชุจุงุฑ 4: ุฃููุงุน ุงูุจูุงูุงุช
๐ Documents: 4
๐ Sections: 315
๐ Paragraphs: 434
โ ุฃููุงุน ุงูุจูุงูุงุช ุตุญูุญุฉ

๐งช ุงุฎุชุจุงุฑ 5: ูุธููุฉ ุงูุจุญุซ

๐ ุงูุจุญุซ ุนู: 'ุงูุฅูุงูุฉ'
   โ ูุฌุฏ 5 ูุชุงุฆุฌ
   ๐ ุฃูุถู ูุชูุฌุฉ: shafi_v1_sec_015 (section)

๐ ุงูุจุญุซ ุนู: 'ุงูุดุฑูู ุงููุฑุชุถู'
   โ ูุฌุฏ 5 ูุชุงุฆุฌ
   ๐ ุฃูุถู ูุชูุฌุฉ: shafi_v1_doc (document)

๐ ุงูุจุญุซ ุนู: 'ุงููุต ุนูู ุงูุฅูุงู'
   โ ูุฌุฏ 5 ูุชุงุฆุฌ
   ๐ ุฃูุถู ูุชูุฌุฉ: shafi_v2_sec_025 (section)

โ ุงูุจุญุซ ูุนูู ุจุดูู ุตุญูุญ

๐งช ุงุฎุชุจุงุฑ 6: ุงูุจุญุซ ูุชุนุฏุฏ ุงููุณุชููุงุช

   ๐ ุงูุจุญุซ ูู documents...
      โ ูุฌุฏ 3 ูุชุงุฆุฌ

   ๐ ุงูุจุญุซ ูู sections...
      โ ูุฌุฏ 3 ูุชุงุฆุฌ

   ๐ ุงูุจุญุซ ูู paragraphs...
      โ ูุฌุฏ 3 ูุชุงุฆุฌ

โ ุงูุจุญุซ ูุชุนุฏุฏ ุงููุณุชููุงุช ูุนูู

๐งช ุงุฎุชุจุงุฑ 7: ุฌูุฏุฉ Embeddings
   ๐ ุงูุชุฏุงุฎู ูู ุงููุชุงุฆุฌ: 3/5
โ ุฌูุฏุฉ Embeddings ุฌูุฏุฉ

======================================================================
โ ูุฌุญุช ุฌููุน ุงูุงุฎุชุจุงุฑุงุช!
======================================================================

๐ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฌุงูุฒุฉ ููุงุณุชุฎุฏุงู!
```

---

## ๐ ุฃูุซูุฉ ุงูุจุญุซ

### ูุซุงู 1: ุจุญุซ ุจุณูุท

```python
import chromadb
from sentence_transformers import SentenceTransformer

# ูุชุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช
client = chromadb.PersistentClient(path="data/database/chroma_db")
collection = client.get_collection("islamic_books")

# ุชุญููู ุงููููุฐุฌ
model = SentenceTransformer("paraphrase-multilingual-mpnet-base-v2")

# ุงูุจุญุซ
query = "ูุง ูู ุงูุฅูุงูุฉุ"
query_embedding = model.encode([query], normalize_embeddings=True)[0]

results = collection.query(
    query_embeddings=[query_embedding.tolist()],
    n_results=5
)

# ุงููุชุงุฆุฌ
for doc_id, metadata in zip(results['ids'][0], results['metadatas'][0]):
    print(f"- {doc_id} ({metadata['type']})")
```

---

### ูุซุงู 2: ุจุญุซ ูุชุนุฏุฏ ุงููุณุชููุงุช

```python
# ุงูุจุญุซ ูู ูู ูุณุชูู
for level in ['document', 'section', 'paragraph']:
    results = collection.query(
        query_embeddings=[query_embedding.tolist()],
        n_results=3,
        where={"type": level}
    )
    
    print(f"\n{level.upper()}S:")
    for doc_id in results['ids'][0]:
        print(f"  - {doc_id}")
```

---

## ๐ ุงูุฃุฏุงุก

### ุงูุณุฑุนุฉ:

| ุงูุฌูุงุฒ | ุงูุณุฑุนุฉ | ุงูููุช ุงูุฅุฌูุงูู |
|--------|--------|----------------|
| CPU (ุนุงุฏู) | ~1 ุนูุตุฑ/ุซุงููุฉ | ~12-15 ุฏูููุฉ |
| CPU (ููู) | ~2 ุนูุตุฑ/ุซุงููุฉ | ~6-8 ุฏูุงุฆู |
| GPU | ~10-20 ุนูุตุฑ/ุซุงููุฉ | ~1-2 ุฏูููุฉ |

### ุญุฌู ุงูุจูุงูุงุช:

```
ูุงุนุฏุฉ ุงูุจูุงูุงุช: ~100-200 MB
ุงููููุฐุฌ (cache): 420 MB
ุงูุฅุฌูุงูู: ~520-620 MB
```

---

## ๐ง ุงูุชุฎุตูุต

### ุชุบููุฑ batch_size:

```yaml
# ูู config.yaml
embeddings:
  batch_size: 16  # ุฃุตุบุฑ = ุฃุจุทุฃ ููู ุฃูู ุงุณุชููุงู ููุฐุงูุฑุฉ
  batch_size: 64  # ุฃูุจุฑ = ุฃุณุฑุน ููู ูุญุชุงุฌ ุฐุงูุฑุฉ ุฃูุซุฑ
```

### ุงุณุชุฎุฏุงู GPU:

```yaml
# ูู config.yaml
embeddings:
  device: "cuda"  # ุจุฏูุงู ูู "cpu"
```

---

## โ ุงููุดุงูู ุงูุดุงุฆุนุฉ

### 1. "CUDA out of memory"

```yaml
# ุญู: ููู batch_size
embeddings:
  batch_size: 8
```

### 2. ุจุทุก ุดุฏูุฏ

```yaml
# ุญู: ุงุณุชุฎุฏู GPU ุฃู ููู ุนุฏุฏ ุงูุนูุงุตุฑ ููุงุฎุชุจุงุฑ
```

### 3. "Collection already exists"

```
# ุญู: ุงูุณูุฑูุจุช ูุญุฐููุง ุชููุงุฆูุงูุ ุฃู ุงุญุฐููุง ูุฏููุงู
rm -rf data/database/chroma_db
```

---

## ๐ ุงูููุงุญุธุงุช

### โ ูุฒุงูุง ุงููููุฐุฌ ุงููุฎุชุงุฑ:

1. **ูุฌุงูู 100%** - ูุญููุ ูุง ูุญุชุงุฌ API
2. **ุฌูุฏุฉ ููุชุงุฒุฉ** - ุฎุงุต ุจุงูุนุฑุจูุฉ
3. **ุณุฑูุน** - 768 ุฃุจุนุงุฏ ููุท
4. **ุฎููู** - 420 MB ููุท

### โ๏ธ ูููุฏ:

1. **ุงูุญุฌู ุงูุฃูุตู** - 384 token ููู ูุต
2. **ุงูุณุฑุนุฉ** - ~1 ุนูุตุฑ/ุซุงููุฉ ุนูู CPU
3. **ุงูุฐุงูุฑุฉ** - ูุญุชุงุฌ ~2 GB RAM

---

## ๐ฏ ุงูุฎุทูุฉ ุงูุชุงููุฉ

โ **Step 3 ููุชูู**

โณ **Step 4: Query Analyzer**
- ุชุญููู ุงูุฃุณุฆูุฉ ุจุงูู AI
- ุงุณุชุฑุงุชูุฌูุงุช ุจุญุซ ุฏููุงููููุฉ
- ุชุญุฏูุฏ ุงููุณุชููุงุช ุงูููุงุณุจุฉ

---

## ๐ ุงููุฑุงุฌุน

- [Sentence Transformers](https://www.sbert.net/)
- [ChromaDB Docs](https://docs.trychroma.com/)
- [paraphrase-multilingual-mpnet-base-v2](https://huggingface.co/sentence-transformers/paraphrase-multilingual-mpnet-base-v2)

---

**ุขุฎุฑ ุชุญุฏูุซ:** ููููุจุฑ 15, 2025  
**ุงููุณุฎุฉ:** 1.0  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุชุดุบูู
