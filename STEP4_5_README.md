# ๐ Step 4 & 5: Query Analyzer + ูุธุงู RAG ุงููุชูุงูู

## ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅุถุงูุฉ ูุฑุญูุชูู ุฌุฏูุฏุชูู ูููุดุฑูุน:

### Step 4: Query Analyzer (ูุญูู ุงูุฃุณุฆูุฉ ุงูุฐูู)
ูุธุงู ุชุญููู ูุชุทูุฑ ููุฃุณุฆูุฉ ูููู ุจู:
- โ ูุดู ุงููุบุฉ ุชููุงุฆูุงู (ุนุฑุจู/ุฅูุฌููุฒู/ูุฎุชูุท)
- โ ุชุตููู ููุน ุงูุณุคุงู (ุชุนุฑููุ ุดุฑุญุ ููุงุฑูุฉุ ูุงุฆูุฉุ ุฅูุฎ)
- โ ุงุณุชุฎุฑุงุฌ ุงููููุงุช ุงูููุชุงุญูุฉ
- โ ุชุญุฏูุฏ ูุณุชูู ุงูุชูุตูู ุงููุทููุจ
- โ ุจูุงุก ุงุณุชุฑุงุชูุฌูุฉ ุจุญุซ ุฐููุฉ

### Step 5: ูุธุงู RAG ุงููุชูุงูู
ูุธุงู Retrieval-Augmented Generation ูุงูู ูุฏูุฌ:
- โ Query Analyzer ูุชุญููู ุงูุฃุณุฆูุฉ
- โ ChromaDB ููุจุญุซ ุงูุฏูุงูู
- โ ุชุฑุชูุจ ูุชุตููุฉ ุงููุชุงุฆุฌ ุงูุฐููุฉ
- โ ูุงุฌูุฉ ุณููุฉ ููุงุณุชุฎุฏุงู

---

## ๐ ุงููููุงุช ุงูุฌุฏูุฏุฉ

```
build/
โโโ step4_query_analyzer.py      # ูุญูู ุงูุฃุณุฆูุฉ
โโโ test_query_analyzer.py       # ุงุฎุชุจุงุฑุงุช Query Analyzer (34 ุงุฎุชุจุงุฑ)
โโโ step5_rag_system.py          # ูุธุงู RAG ุงููุชูุงูู
โโโ test_rag_system.py           # (ูุฑูุจุงู)
```

---

## ๐ ุงูุชุซุจูุช

ุฌููุน ุงูููุชุจุงุช ููุฌูุฏุฉ ุจุงููุนู ูู `requirements.txt`:

```bash
pip install -r requirements.txt
```

---

## ๐ ุงูุงุณุชุฎุฏุงู

### 1. Query Analyzer ููุท

```python
from step4_query_analyzer import QueryAnalyzer

# ุฅูุดุงุก ูุญูู
analyzer = QueryAnalyzer()

# ุชุญููู ุณุคุงู
analysis = analyzer.analyze("ูู ูู ุงูุดุฑูู ุงููุฑุชุถูุ")

# ุทุจุงุนุฉ ุงููุชูุฌุฉ
analyzer.print_analysis(analysis)
```

**ุงููุชูุฌุฉ:**

```
======================================================================
๐ ุชุญููู ุงูุณุคุงู
======================================================================

๐ ุงูุณุคุงู: ูู ูู ุงูุดุฑูู ุงููุฑุชุถูุ

๐ ุงููุบุฉ: arabic (100%)
๐ ููุน ุงูุณุคุงู: factual (100%)
๐ ูุณุชูู ุงูุชูุตูู: moderate

โ ูููุงุช ุงูุณุคุงู: ูู

๐ ุงููููุงุช ุงูููุชุงุญูุฉ:
   1. ุงูุดุฑูู
   2. ุงููุฑุชุถู

๐ฏ ุงุณุชุฑุงุชูุฌูุฉ ุงูุจุญุซ:
   โข ุนุฏุฏ ุงููุชุงุฆุฌ: 5
   โข ุฃููููุฉ ุงููุณุชููุงุช: paragraph โ section โ document
   โข ุฃูุถุงุน ุงูุจุญุซ: semantic, keyword
```

---

### 2. ูุธุงู RAG ุงููุงูู

```python
from step5_rag_system import RAGSystem

# ุชููุฆุฉ ุงููุธุงู
rag = RAGSystem()

# ุทุฑุญ ุณุคุงู
response = rag.ask("ูุง ูู ุชุนุฑูู ุงูุฅูุงูุฉ ูู ุงูููุฑ ุงูุดูุนูุ")
```

**ุงููุชูุฌุฉ:**

```
๐ ุชุญููู ุงูุณุคุงู: ูุง ูู ุชุนุฑูู ุงูุฅูุงูุฉ ูู ุงูููุฑ ุงูุดูุนูุ
   ๐ ููุน ุงูุณุคุงู: definition
   ๐ ุงููุบุฉ: arabic
   ๐ ูุณุชูู ุงูุชูุตูู: moderate
   ๐ฏ ุนุฏุฏ ุงููุชุงุฆุฌ ุงููุทููุจุฉ: 5

๐ข ุชูููุฏ embedding ููุณุคุงู...
๐พ ุงูุจุญุซ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช...
๐ ูุนุงูุฌุฉ ุงููุชุงุฆุฌ...
โ ุชู ุงูุนุซูุฑ ุนูู 5 ูุชูุฌุฉ ูู 0.34 ุซุงููุฉ

======================================================================
๐ ูุชุงุฆุฌ ุงูุจุญุซ
======================================================================

๐ ุนุฏุฏ ุงููุชุงุฆุฌ: 5
โฑ๏ธ  ุงูููุช: 0.34 ุซุงููุฉ

----------------------------------------------------------------------
๐ฏ ุฃูุถู ุงููุชุงุฆุฌ:
----------------------------------------------------------------------

1. [PARAGRAPH] shafi_v2_sec_074_para_001
   ๐ ุงูููุงุท: 0.8547 | ุงููุณุงูุฉ: 0.2341
   ๐ ุงููุชุงุจ: ุงูุดุงูู ูู ุงูุฅูุงูุฉ
   โ๏ธ  ุงููุคูู: ุงูุดุฑูู ุงููุฑุชุถู
   ๐ ูุฅู ููู ููุง ูุง ุงูุฅูุงูุฉ ุนูุฏูู ููุง ุญูููุชูุง...
```

---

## ๐งช ุงูุงุฎุชุจุงุฑุงุช

### ุชุดุบูู ุงุฎุชุจุงุฑุงุช Query Analyzer:

```bash
python build/test_query_analyzer.py
```

**ุงููุชูุฌุฉ:**

```
======================================================================
๐ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑุงุช
======================================================================

โ ูุฌุญ: 34
โ ูุดู: 0
๐ ุงููุฌููุน: 34
๐ ูุณุจุฉ ุงููุฌุงุญ: 100.0%

๐ ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ูุฌุญุช!
```

### ุชุดุบูู ูุซุงู Query Analyzer:

```bash
python build/step4_query_analyzer.py
```

### ุชุดุบูู ูุธุงู RAG ุงููุงูู:

```bash
python build/step5_rag_system.py
```

---

## ๐ Query Analyzer - ุงูุชูุงุตูู

### ุฃููุงุน ุงูุฃุณุฆูุฉ ุงููุฏุนููุฉ

| ุงูููุน | ุงููุตู | ุฃูุซูุฉ |
|------|-------|-------|
| **factual** | ุณุคุงู ุญูููู | ููุ ูุงุฐุงุ ูุชูุ ุฃููุ |
| **definition** | ุชุนุฑูู | ูุง ููุ ูุง ูุนููุ |
| **explanation** | ุดุฑุญ | ุงุดุฑุญุ ูุถุญุ ูููุ |
| **comparison** | ููุงุฑูุฉ | ุงููุฑู ุจููุ ูุงุฑู |
| **opinion** | ุฑุฃู | ูุง ุฑุฃููุ |
| **list** | ูุงุฆูุฉ | ุงุฐูุฑุ ุนุฏุฏ |
| **procedural** | ุฅุฌุฑุงุฆู | ููู ุฃูุนูุ |

### ูุณุชููุงุช ุงูุชูุตูู

| ุงููุณุชูู | ุนุฏุฏ ุงููุชุงุฆุฌ | ุงููุตู |
|---------|-------------|-------|
| **brief** | 3 | ุฅุฌุงุจุฉ ููุฌุฒุฉ |
| **moderate** | 5 | ุฅุฌุงุจุฉ ูุชูุณุทุฉ (ุงูุชุฑุงุถู) |
| **detailed** | 10 | ุฅุฌุงุจุฉ ููุตูุฉ |

### ูุดู ุงููุบุฉ

- **ุนุฑุจู**: 70%+ ุญุฑูู ุนุฑุจูุฉ
- **ุฅูุฌููุฒู**: 70%+ ุญุฑูู ูุงุชูููุฉ
- **ูุฎุชูุท**: ุฃูู ูู 70% ูุฃู ูุบุฉ

---

## ๐ฏ ุงุณุชุฑุงุชูุฌูุงุช ุงูุจุญุซ

Query Analyzer ููุชุฑุญ ุงุณุชุฑุงุชูุฌูุฉ ุจุญุซ ูุฎุตุตุฉ ููู ููุน ุณุคุงู:

### ูุซุงู 1: ุณุคุงู ุญูููู (Who/What)

```python
analysis = analyzer.analyze("ูู ูู ุงูุดุฑูู ุงููุฑุชุถูุ")

# ุงุณุชุฑุงุชูุฌูุฉ ุงูุจุญุซ:
{
    'n_results': 5,
    'level_priority': ['paragraph', 'section', 'document'],
    'use_reranking': False,
    'expand_query': False,
    'search_modes': ['semantic', 'keyword']
}
```

### ูุซุงู 2: ุทูุจ ุดุฑุญ ููุตู

```python
analysis = analyzer.analyze("ุงุดุฑุญ ุจุงูุชูุตูู ููููู ุงูุนุตูุฉ")

# ุงุณุชุฑุงุชูุฌูุฉ ุงูุจุญุซ:
{
    'n_results': 10,  # ููุตู = 10 ูุชุงุฆุฌ
    'level_priority': ['section', 'paragraph', 'document'],
    'use_reranking': True,  # ุฅุนุงุฏุฉ ุชุฑุชูุจ ููุชูุตูู
    'expand_query': False,
    'search_modes': ['semantic']
}
```

### ูุซุงู 3: ููุงุฑูุฉ

```python
analysis = analyzer.analyze("ูุง ุงููุฑู ุจูู ุงูุฅูุงูุฉ ูุงูุฎูุงูุฉุ")

# ุงุณุชุฑุงุชูุฌูุฉ ุงูุจุญุซ:
{
    'n_results': 5,
    'level_priority': ['section', 'document', 'paragraph'],
    'use_reranking': False,
    'expand_query': True,  # ุชูุณูุน ุงูุณุคุงู
    'search_modes': ['semantic', 'multi_query']
}
```

---

## ๐ง ูุงุฌูุฉ RAG System

### ูุนุงููุงุช ุงูุจุญุซ

```python
rag.search(
    query="ุงูุณุคุงู",
    n_results=5,              # ุนุฏุฏ ุงููุชุงุฆุฌ (None = ุชููุงุฆู)
    filter_by_type="section", # ุชุตููุฉ ุญุณุจ ุงูููุน (ุงุฎุชูุงุฑู)
    min_score=0.5             # ุงูุญุฏ ุงูุฃุฏูู ููููุงุท
)
```

### ุฃููุงุน ุงูุจูุงูุงุช ุงููุงุจูุฉ ููุชุตููุฉ

- `document`: ุงููุณุชูุฏ ุงููุงูู
- `section`: ูุณู ูู ุงููุชุงุจ
- `paragraph`: ููุฑุฉ ูุญุฏุฏุฉ

---

## ๐ ุงูุฃุฏุงุก

### Query Analyzer

- โก **ุงูุณุฑุนุฉ**: < 0.01 ุซุงููุฉ
- ๐ฏ **ุงูุฏูุฉ**: 100% (34/34 ุงุฎุชุจุงุฑ)
- ๐พ **ุงูุฐุงูุฑุฉ**: < 1 MB

### RAG System (ูุน E5 Embeddings)

- โก **ุงูุจุญุซ**: 0.3-0.5 ุซุงููุฉ
- ๐ **ุงูุฏูุฉ**: ุนุงููุฉ ุฌุฏุงู (E5 model)
- ๐พ **ุงูุฐุงูุฑุฉ**: ~2 GB (model + database)

---

## ๐ ุฃูุซูุฉ ูุชูุฏูุฉ

### 1. ุงูุจุญุซ ุจุชุตููุฉ ุญุณุจ ุงูููุน

```python
# ุงูุจุญุซ ูู ุงูููุฑุงุช ููุท
response = rag.search(
    "ูู ูู ุงูุดุฑูู ุงููุฑุชุถูุ",
    filter_by_type="paragraph"
)
```

### 2. ุงูุจุญุซ ุจุญุฏ ุฃุฏูู ููููุงุท

```python
# ููุท ุงููุชุงุฆุฌ ุงูุฃุนูู ูู 70%
response = rag.search(
    "ูุง ูู ุชุนุฑูู ุงูุฅูุงูุฉุ",
    min_score=0.7
)
```

### 3. ุงูุชุญูู ูู ุนุฏุฏ ุงููุชุงุฆุฌ

```python
# ุฅุฌุงุจุฉ ููุฌุฒุฉ (3 ูุชุงุฆุฌ)
response = rag.search(
    "ุงุดุฑุญ ุจุฅูุฌุงุฒ ููููู ุงูุฅูุงูุฉ",
    n_results=3
)

# ุฅุฌุงุจุฉ ููุตูุฉ (15 ูุชูุฌุฉ)
response = rag.search(
    "ุงุดุฑุญ ุจุงูุชูุตูู ููููู ุงูุฅูุงูุฉ",
    n_results=15
)
```

### 4. ุงููุตูู ูููุชุงุฆุฌ ุจุฑูุฌูุงู

```python
response = rag.search("ูู ูู ุงูุดุฑูู ุงููุฑุชุถูุ")

for result in response.results:
    print(f"ID: {result.id}")
    print(f"Type: {result.type}")
    print(f"Score: {result.score:.4f}")
    print(f"Content: {result.content[:100]}...")
    print(f"Metadata: {result.metadata}")
    print()
```

---

## ๐ ุจููุฉ QueryAnalysis

```python
@dataclass
class QueryAnalysis:
    original_query: str                    # ุงูุณุคุงู ุงูุฃุตูู
    language: str                          # ุงููุบุฉ (arabic/english/mixed)
    language_confidence: float             # ุซูุฉ ุงููุบุฉ (0-1)
    query_type: str                        # ููุน ุงูุณุคุงู
    query_type_confidence: float           # ุซูุฉ ุงูุชุตููู (0-1)
    keywords: List[str]                    # ุงููููุงุช ุงูููุชุงุญูุฉ
    question_words: List[str]              # ูููุงุช ุงูุณุคุงู
    detail_level: str                      # ูุณุชูู ุงูุชูุตูู
    search_strategy: Dict                  # ุงุณุชุฑุงุชูุฌูุฉ ุงูุจุญุซ
    metadata: Dict                         # ูุนูููุงุช ุฅุถุงููุฉ
    timestamp: str                         # ููุช ุงูุชุญููู
```

---

## ๐ ุจููุฉ RAGResponse

```python
@dataclass
class RAGResponse:
    query: str                             # ุงูุณุคุงู
    query_analysis: QueryAnalysis          # ุชุญููู ุงูุณุคุงู
    results: List[SearchResult]            # ุงููุชุงุฆุฌ
    total_results: int                     # ุนุฏุฏ ุงููุชุงุฆุฌ
    search_time: float                     # ููุช ุงูุจุญุซ (ุซูุงูู)
    timestamp: str                         # ุงูููุช
```

---

## ๐ ูููุฒุงุช ูุชูุฏูุฉ

### 1. ุงูุชุฑุชูุจ ุงูุฐูู

ุงููุธุงู ููุนุทู ุฃููููุฉ ูููุณุชููุงุช ุงูููุงุณุจุฉ ููู ููุน ุณุคุงู:

- **ุณุคุงู ุญูููู** (ููุ ูุงุฐุงุ): `paragraph` โ `section` โ `document`
- **ุชุนุฑูู**: `paragraph` โ `section` โ `document`
- **ุดุฑุญ**: `section` โ `paragraph` โ `document`
- **ููุงุฑูุฉ**: `section` โ `document` โ `paragraph`

### 2. ููุงุท ูุฑูุจุฉ

ุงููุชุงุฆุฌ ุชูุฑุชุจ ุญุณุจ:
- **ุงููุณุงูุฉ ุงูุฏูุงููุฉ** ูู Embedding (70%)
- **ุฃููููุฉ ุงููุณุชูู** ุงูููุงุณุจ ููุณุคุงู (+10%)

### 3. ุงุณุชุฎุฑุงุฌ ุงููููุงุช ุงูููุชุงุญูุฉ ุงูุฐูู

- ููุฒูู ูููุงุช ุงูุณุคุงู (ููุ ูุงุฐุงุ etc.)
- ููุฒูู ูููุงุช ุงูุชููู ุงูุนุฑุจูุฉ (ููุ ุนููุ etc.)
- ูุญุชูุธ ุจุงููููุงุช ุงูุฌููุฑูุฉ ููุท

---

## ๐ฏ ุญุงูุงุช ุงูุงุณุชุฎุฏุงู

### 1. ูุธุงู ุณุคุงู ูุฌูุงุจ

```python
rag = RAGSystem()

while True:
    query = input("ุงุณุฃู ุณุคุงูู: ")
    if query.lower() in ['exit', 'ุฎุฑูุฌ']:
        break

    response = rag.ask(query)
```

### 2. ูุนุงูุฌุฉ ุฏูุนุงุช ูู ุงูุฃุณุฆูุฉ

```python
questions = [
    "ูู ูู ุงูุดุฑูู ุงููุฑุชุถูุ",
    "ูุง ูู ุชุนุฑูู ุงูุฅูุงูุฉุ",
    "ุงุดุฑุญ ููููู ุงูุนุตูุฉ"
]

for q in questions:
    response = rag.search(q)
    # ูุนุงูุฌุฉ ุงููุชุงุฆุฌ...
```

### 3. ุชุญููู ุงูุฃุณุฆูุฉ ููุท (ุจุฏูู ุจุญุซ)

```python
analyzer = QueryAnalyzer()

query = "ูุง ุงููุฑู ุจูู ุงูุฅูุงูุฉ ูุงูุฎูุงูุฉุ"
analysis = analyzer.analyze(query)

print(f"ููุน ุงูุณุคุงู: {analysis.query_type}")
print(f"ูุณุชูู ุงูุชูุตูู: {analysis.detail_level}")
print(f"ุงููููุงุช ุงูููุชุงุญูุฉ: {analysis.keywords}")
```

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุฎุทุฃ: Collection not found

```python
# ุชุฃูุฏ ูู ุงุณู Collection ุงูุตุญูุญ
rag = RAGSystem(collection_name="islamic_books_e5")
```

### ุฎุทุฃ: Model download fails

```python
# ูุฏ ูุญุชุงุฌ ููุช ุทููู ูุฃูู ูุฑุฉ
# ุชุฃูุฏ ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช
```

### ุฎุทุฃ: No results found

```python
# ุชุฃูุฏ ูู ูุฌูุฏ ุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
collection = client.get_collection("islamic_books_e5")
print(f"ุนุฏุฏ ุงูุนูุงุตุฑ: {collection.count()}")
```

---

## ๐ ุงููุฑุงุฌุน

- **E5 Model**: [intfloat/multilingual-e5-large](https://huggingface.co/intfloat/multilingual-e5-large)
- **ChromaDB**: [docs.trychroma.com](https://docs.trychroma.com/)
- **Sentence Transformers**: [sbert.net](https://www.sbert.net/)

---

## ๐ ุงูุฎูุงุตุฉ

ุงูุขู ูุฏูู:

โ **Query Analyzer** ุฐูู ูููู ุงูุฃุณุฆูุฉ
โ **ูุธุงู RAG** ูุชูุงูู ููุจุญุซ ุงูุฏูุงูู
โ **34 ุงุฎุชุจุงุฑ** ุจูุณุจุฉ ูุฌุงุญ 100%
โ **ุชูุซูู ุดุงูู** ูุน ุฃูุซูุฉ
โ **ุฃุฏุงุก ุนุงูู** ูุณุฑุนุฉ ููุชุงุฒุฉ

**ุงููุดุฑูุน ุฌุงูุฒ ููุงุณุชุฎุฏุงู! ๐**

---

## ๐ง ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู:
1. ุชุญูู ูู ุงูุงุฎุชุจุงุฑุงุช: `python build/test_query_analyzer.py`
2. ุฑุงุฌุน ูุฐุง ุงูุชูุซูู
3. ุงูุญุต ูููุงุช ุงูุฃูุซูุฉ ูู `build/`

---

**ุงูุฅุตุฏุงุฑ**: 1.0.0
**ุงูุชุงุฑูุฎ**: 2025-11-15
**ุงูุชุฑุฎูุต**: MIT
